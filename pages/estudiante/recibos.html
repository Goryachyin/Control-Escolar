<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Solicitud de Recibos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --primary-color: #4a6b8a;
      --secondary-color: #e0e7f0;
      --text-color: #333;
      --light-bg: #f5f7fa;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--light-bg); }

    #service-list { max-width: 600px; margin: 40px auto; background: var(--card-bg); border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .service-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
    .service-item:last-child { border-bottom: none; }
    .service-item span { font-size: 16px; color: var(--text-color); }
    .service-item button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }

    #my-receipts-btn { display: block; margin: 20px auto; background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }

    /* Panel deslizable */
    #receipts-panel { position: fixed; top: 0; right: -100%; width: 350px; height: 100%; background: var(--card-bg); box-shadow: -2px 0 6px rgba(0,0,0,0.2); overflow-y: auto; transition: right 0.3s ease; z-index: 1000; padding: 20px; }
    #receipts-panel.visible { right: 0; }
    .receipt-item { margin-bottom: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; }
    .receipt-item:hover { background: var(--secondary-color); }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal.visible { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 6px; width: 90%; max-width: 400px; text-align: center; }
    .modal-content p { margin-bottom: 20px; font-size: 16px; }
    .modal-content button { margin: 0 10px; padding: 8px 14px; border: none; border-radius: 4px; cursor: pointer; }
    .modal-content .cancel { background: #ccc; color: #333; }
    .modal-content .confirm { background: var(--primary-color); color: white; }

    /* Recibo */
    #receipt { display: none; max-width: 600px; margin: 40px auto; background: var(--card-bg); border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #receipt h2 { margin-bottom: 20px; color: var(--primary-color); }
    #receipt p { margin-bottom: 10px; font-size: 15px; }
    #receipt img { display: block; margin: 20px auto; max-width: 200px; }
    #receipt .actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    #receipt button { padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="service-list"></div>
  <button id="my-receipts-btn" onclick="toggleReceiptsPanel()">Ver mis Recibos</button>

  <div id="receipts-panel"></div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <p id="modal-text">¿Desea solicitar un recibo para $0.00?</p>
      <button class="cancel" onclick="closeModal()">Cancelar</button>
      <button class="confirm" id="btn-confirm">Solicitar</button>
    </div>
  </div>

  <div id="receipt"></div>

  <script>
    const services = [
      { id: 1, name: "CERTIFICADO DE ESTUDIOS EGRESO", amount: 200.00 },
      { id: 2, name: "CONSTANCIA DE ESTUDIOS                    ", amount: 50.00 },
      { id: 3, name: "DUPLICADO DE CREDENCIAL       ", amount: 100.00 },
      { id: 4, name: "DONATIVO DE LIBRO EGRESO      ", amount: 500.00 },
      { id: 5, name: "CURSOS DE INGLES             ", amount: 1050.00 },
      { id: 6, name: "TRAMITE DE TITULO            ", amount: 2600.00 }
    ];

    const myReceipts = [];

    function renderList() {
      const list = document.getElementById('service-list');
      services.forEach(svc => {
        const div = document.createElement('div');
        div.className = 'service-item';
        div.innerHTML = `
          <span>${svc.name}</span>
          <span>$${svc.amount.toFixed(2)}</span>
          <button onclick="confirmar(${svc.id})">Solicitar</button>
        `;
        list.appendChild(div);
      });
    }

    function confirmar(id) {
      const svc = services.find(x => x.id === id);
      document.getElementById('modal-text').textContent = `¿Desea solicitar un recibo para $${svc.amount.toFixed(2)}?`;
      document.getElementById('btn-confirm').onclick = () => createCharge(svc);
      document.getElementById('modal').classList.add('visible');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('visible');
    }

    async function createCharge({ id, name, amount }) {
      closeModal();
      const reference = Math.random().toString(36).substring(2,10).toUpperCase();
      const convenio = 7170;
      const bank = 'BBVA';
      const qrData = encodeURIComponent(`https://bbva.mx/pay?cv=${convenio}&ref=${reference}`);
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code?size=200x200&data=${qrData}`;

      const data = { concept: name, amount, bank, convenio, reference, qrCodeUrl };
      myReceipts.push(data);

      showReceipt(data);
      renderReceiptsPanel();
    }

    function hideReceipt() {
     const receipt = document.getElementById('receipt');
     receipt.style.display = 'none';

     const panel = document.getElementById('receipts-panel');
     panel.classList.add('visible'); // Aseguramos que el panel esté abierto
      }
      

    function showReceipt({ concept, amount, bank, convenio, reference, qrCodeUrl }) {

      const r = document.getElementById('receipt');
      r.innerHTML = `
        <h2>Recibo de pago</h2>
        <p><strong>Concepto:</strong> ${concept}</p>
        <p><strong>Banco:</strong> ${bank} (Convenio ${convenio})</p>
        <p><strong>Total a pagar:</strong> $${amount.toFixed(2)}</p>
        <p><strong>Referencia:</strong> ${reference}</p>
        <img id="qr-img" crossOrigin="anonymous" src="${qrCodeUrl}" alt="QR para pago">
        <div class="actions">
          <button id="download-pdf">Descargar PDF</button>
          <button onclick="hideReceipt()">Volver</button>
        </div>
      `;
      r.style.display = 'block';


      document.getElementById('download-pdf').onclick = () => {
        html2pdf().from(r).set({
          margin: 0.5,
          filename: `Recibo-${reference}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        }).save();
      };

       // Configurar descarga PDF incluyendo el QR
       document.getElementById('download-pdf').onclick = () => {
      // 1. Ocultar botones antes de generar PDF
      const actions = r.querySelector('.actions');
      actions.style.display = 'none';

     // 2. Generar y descargar el PDF
      html2pdf().from(r).set({
       margin: 0.5,
      filename: `Recibo-${reference}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
       jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
       }).save()
       .then(() => {
        // 3. Volver a mostrar los botones después de la descarga
        actions.style.display = 'flex';
         });
        };
    }

    function renderReceiptsPanel() {
      const panel = document.getElementById('receipts-panel');
      panel.innerHTML = `<h3 style="margin-bottom:20px;">Mis Recibos</h3>`;
      myReceipts.forEach((recibo, index) => {
        const div = document.createElement('div');
        div.className = 'receipt-item';
        div.innerHTML = `
          <strong>${recibo.concept}</strong><br>
          Vigente hasta: 30/06/2025
          <br>Importe: $${recibo.amount.toFixed(2)}
        `;
        div.onclick = () => showReceipt(recibo);
        panel.appendChild(div);
      });
    }

    function toggleReceiptsPanel() {
      const panel = document.getElementById('receipts-panel');
      panel.classList.toggle('visible');
    }

    window.onload = renderList;
  </script>

</body>
</html>



 